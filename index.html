<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Èò≤Ë©êÈ®ôÂÅµÊé¢ÈÅäÊà≤</title>
    <style>
        :root {
            --neon-green: #00ff41;
            --neon-red: #ff0033;
            --bg-color: #111;
        }
        body {
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            background-color: var(--bg-color);
            color: white;
            margin: 0;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none;
        }

        /* --- START SCREEN (NEW) --- */
        #startScreen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .start-title {
            font-size: 5rem;
            color: var(--neon-green);
            text-shadow: 0 0 40px var(--neon-green);
            margin-bottom: 20px;
            font-weight: 900;
            text-align: center;
            letter-spacing: 5px;
        }

        .start-subtitle {
            font-size: 2rem;
            color: #ccc;
            margin-bottom: 60px;
            letter-spacing: 2px;
        }

        .start-btn {
            padding: 25px 80px;
            font-size: 3rem;
            background: transparent;
            color: var(--neon-green);
            border: 4px solid var(--neon-green);
            border-radius: 50px;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: bold;
            box-shadow: 0 0 20px var(--neon-green);
            transition: all 0.3s;
            animation: pulse 2s infinite;
        }

        .start-btn:hover {
            background: var(--neon-green);
            color: black;
            box-shadow: 0 0 50px var(--neon-green);
            transform: scale(1.05);
        }

        /* --- GAME IMAGE --- */
        #gameImage {
            width: 100vw;
            height: 100vh;
            object-fit: contain;
            z-index: 1;
        }

        /* --- RIGHT SIDE: POLICE & PROGRESS --- */
        .police-panel {
            position: absolute;
            bottom: 20px;
            right: 20px; 
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 10;
        }

        .police-img-main {
            width: 220px;
            height: auto;
            transition: transform 0.2s;
            filter: drop-shadow(0 0 10px rgba(0,0,0,0.8));
        }

        .progress-container {
            width: 200px;
            height: 20px;
            background: #333;
            border: 2px solid white;
            border-radius: 10px;
            margin-top: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-bar {
            height: 100%;
            width: 0%; 
            background: linear-gradient(90deg, #ffeb3b, var(--neon-green));
            transition: width 0.5s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        /* --- LEFT SIDE: EQUIPMENT COLLECTION --- */
        .equipment-panel {
            position: absolute;
            bottom: 20px; 
            left: 20px;  
            width: 260px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 15px;
            z-index: 10;
            border: 1px solid #555;
            backdrop-filter: blur(5px);
        }

        .collection-title {
            text-align: center;
            margin-bottom: 10px;
            font-size: 1.2rem;
            color: #ffeb3b;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .grid-item {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid #444;
            transition: all 0.3s;
        }

        .grid-item img {
            width: 80%;
            height: 80%;
            object-fit: contain;
            opacity: 0.2; 
            filter: grayscale(100%);
            transition: all 0.5s;
        }

        .unlocked {
            background: rgba(255, 255, 255, 0.9) !important;
            border-color: var(--neon-green) !important;
            box-shadow: 0 0 15px var(--neon-green);
            transform: scale(1.1);
            z-index: 5;
        }
        
        .unlocked img {
            opacity: 1 !important;
            filter: grayscale(0%) !important;
        }

        /* --- CLOCK --- */
        .clock-container {
            position: absolute;
            top: 20px;
            right: 30px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 3rem;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            z-index: 10;
            background: rgba(0,0,0,0.4);
            padding: 5px 20px;
            border-radius: 10px;
            border: 1px solid #555;
        }
        .clock-danger {
            color: var(--neon-red);
            font-size: 5rem;
            animation: heartBeat 1s infinite;
            background: rgba(0,0,0,0.9);
            border: 4px solid var(--neon-red);
        }

        /* --- BUTTONS --- */
        .controls {
            position: absolute;
            bottom: 30px;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 60px;
            z-index: 15;
            pointer-events: none;
        }
        .btn-float {
            pointer-events: auto;
            padding: 15px 50px;
            font-size: 2.2rem;
            font-weight: 900;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            text-transform: uppercase;
            box-shadow: 0 10px 30px rgba(0,0,0,0.9);
            transition: transform 0.1s;
        }
        .btn-real { background: #2e7d32; color: white; border: 4px solid #66bb6a; }
        .btn-fake { background: #c62828; color: white; border: 4px solid #ef5350; }
        .btn-float:active { transform: scale(0.95); }

        /* --- FEEDBACK OVERLAY --- */
        .feedback-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 30;
            display: none;
            justify-content: center;
            align-items: center;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(8px);
        }

        .feedback-container {
            display: flex;
            align-items: center;
            gap: 50px;
        }

        .feedback-police-img {
            height: 400px;
            width: auto;
            filter: drop-shadow(0 0 20px rgba(255,255,255,0.2));
            animation: popIn 0.5s;
        }

        .feedback-text-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        /* --- ICONS --- */
        .success-mark {
            width: 200px;
            height: 200px;
            border: 25px solid var(--neon-green);
            border-radius: 50%;
            background: transparent;
            box-shadow: 0 0 50px var(--neon-green);
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            margin-bottom: 30px;
        }

        .cross-mark { 
            font-size: 30rem;
            line-height: 1;
            color: var(--neon-red); 
            animation: shake 0.4s; 
            text-shadow: 0 0 80px var(--neon-red); 
            margin-bottom: 20px;
        }
        
        .educational-text { 
            color: white; 
            font-size: 2rem; 
            font-weight: bold;
        }
        
        .continue-hint { 
            margin-top: 50px; 
            color: #aaa; 
            font-size: 1.5rem; 
            animation: pulse 2s infinite; 
        }
        
        .reset-link { 
            position: absolute; 
            bottom: 5px; 
            left: 5px; 
            color: #555; 
            font-size: 0.9rem; 
            cursor: pointer; 
            z-index: 50; 
            padding: 5px;
            text-decoration: underline;
        }
        .reset-link:hover { color: #fff; }

        .end-game-btn {
            background: var(--neon-green);
            color: black;
            padding: 20px 40px;
            font-size: 2rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 20px;
            font-weight: bold;
            box-shadow: 0 0 20px var(--neon-green);
        }

        /* --- ANIMATIONS --- */
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-30px); } 75% { transform: translateX(30px); } 100% { transform: translateX(0); } }
        @keyframes popIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        @keyframes heartBeat { 0% { transform: scale(1); } 15% { transform: scale(1.1); } 30% { transform: scale(1); } 45% { transform: scale(1.1); } 60% { transform: scale(1); } 100% { transform: scale(1); } }
        
        /* CONFETTI FROM TOP */
        .confetti { 
            position: absolute; 
            top: -20px; 
            width: 15px; 
            height: 15px; 
            z-index: 100; 
            animation: fall linear forwards; 
        }
        @keyframes fall { 
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(110vh) rotate(720deg); opacity: 0; } 
        }

    </style>
</head>
<body>

    <!-- START SCREEN -->
    <div id="startScreen">
        <div class="start-title">AI Èò≤Ë©êÈ®ôÂÅµÊé¢</div>
        <div class="start-subtitle">Ê∫ñÂÇôÂ•ΩÊåëÊà∞‰Ω†ÁöÑËßÄÂØüÂäõ‰∫ÜÂóéÔºü</div>
        <button class="start-btn" onclick="startGame()">ÈñãÂßãÈÅäÊà≤</button>
        <div style="margin-top:20px; color:#555; font-size: 0.8rem; cursor:pointer;" onclick="resetMemory()">[Ê∏ÖÈô§ËàäÁ¥ÄÈåÑ]</div>
    </div>

    <!-- MAIN GAME IMAGE -->
    <img id="gameImage" src="" alt="Game Image">

    <!-- CLOCK -->
    <div id="clock" class="clock-container">10</div>

    <!-- RIGHT: POLICE & PROGRESS -->
    <div class="police-panel">
        <img id="policeMain" class="police-img-main" src="police_images/Althea_happy.png" alt="Police">
        <div class="progress-container">
            <div id="progressBar" class="progress-bar"></div>
        </div>
    </div>

    <!-- LEFT: EQUIPMENT COLLECTION -->
    <div class="equipment-panel">
        <div class="collection-title">Ë£ùÂÇôÊî∂ÈõÜÂÜä</div>
        <div class="grid-container" id="gridContainer">
            <!-- Items generated by JS -->
        </div>
    </div>

    <!-- CONTROLS -->
    <div class="controls" id="btnContainer">
        <button class="btn-float btn-real" onclick="makeGuess('real')">üì∏ Áúü‰∫∫ÁÖßÁâá</button>
        <button class="btn-float btn-fake" onclick="makeGuess('fake')">ü§ñ AI ÁîüÊàê</button>
    </div>

    <!-- FEEDBACK OVERLAY -->
    <div id="feedbackOverlay" class="feedback-overlay" onclick="nextPhoto()">
        <div class="feedback-container">
            <div class="feedback-text-area">
                <div id="feedbackIcon"></div>
                <div id="feedbackText" class="educational-text"></div>
                <button id="restartBtn" class="end-game-btn" style="display:none;" onclick="resetMemory(); event.stopPropagation();">ÈáçÊñ∞ÈñãÂßã</button>
            </div>
             <img id="feedbackPoliceImg" class="feedback-police-img" src="" alt="Reaction">
        </div>
        <div id="continueHint" class="continue-hint">ÈªûÊìäÁï´Èù¢ Êàñ ÊåâÁ©∫ÁôΩÈçµ ÁπºÁ∫å...</div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const TIME_LIMIT = 10;
        const TOTAL_IMAGES_PER_TYPE = 30; 
        const MAX_ITEMS = 12;

        // --- STATE ---
        let currentType = ''; 
        let currentTimer = TIME_LIMIT;
        let timerInterval;
        let heartbeatInterval;
        let heartbeatVolume = 0.5;
        let isGameActive = false;
        let currentScore = 0; 

        // Memory Logic
        let usedReal = JSON.parse(localStorage.getItem('ai_game_used_real')) || [];
        let usedFake = JSON.parse(localStorage.getItem('ai_game_used_fake')) || [];

        // --- AUDIO ENGINE ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function resumeAudio() { if (audioCtx.state === 'suspended') audioCtx.resume(); }

        function playTone(freq, type, duration, vol=0.1) {
            resumeAudio();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.value = freq;
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            osc.stop(audioCtx.currentTime + duration);
        }

        // --- SOUND EFFECTS ---
        function playTick() { playTone(800, 'square', 0.05, 0.05); }
        
        function playHeartbeat() {
            playTone(60, 'triangle', 0.1, heartbeatVolume);
            setTimeout(() => playTone(50, 'triangle', 0.15, heartbeatVolume * 0.8), 150);
            if(heartbeatVolume < 2.0) heartbeatVolume += 0.1;
        }

        function playFailSound() {
            playTone(100, 'sawtooth', 0.6, 0.4);
            setTimeout(() => playTone(80, 'sawtooth', 0.6, 0.4), 200);
        }

        function playSuccessSound() {
            const audio = new Audio('cheer.mp3');
            audio.volume = 1.0;
            audio.play().catch(e => console.log("Audio play failed:", e));
        }

        // --- INIT ---
        function generateGrid() {
            const grid = document.getElementById('gridContainer');
            grid.innerHTML = '';
            for(let i=1; i<=MAX_ITEMS; i++) {
                const div = document.createElement('div');
                div.className = 'grid-item';
                div.id = `slot-${i}`;
                div.innerHTML = `<img src="equipments/eq_${i}.png" alt="Item ${i}">`;
                grid.appendChild(div);
            }
            updateCollectionVisuals(); 
        }

        function startGame() {
            // User gesture triggers audio context
            resumeAudio();
            document.getElementById('startScreen').style.display = 'none';
            generateGrid();
            document.getElementById('feedbackOverlay').style.display = 'none';
            document.getElementById('policeMain').src = "police_images/Althea_happy.png";
            loadNextPhoto();
        }

        function loadNextPhoto() {
            // RESET Police to Happy for new round
            document.getElementById('policeMain').src = "police_images/Althea_happy.png";

            currentType = Math.random() < 0.5 ? 'real' : 'fake';
            
            // CHECK IF FULL
            if (usedReal.length >= TOTAL_IMAGES_PER_TYPE && usedFake.length >= TOTAL_IMAGES_PER_TYPE) {
                showEndGameScreen();
                return;
            }

            let photoId;
            let pool = currentType === 'real' ? usedReal : usedFake;
            let available = [];
            for(let i=1; i<=TOTAL_IMAGES_PER_TYPE; i++) if(!pool.includes(i)) available.push(i);

            if (available.length === 0) {
                currentType = currentType === 'real' ? 'fake' : 'real';
                pool = currentType === 'real' ? usedReal : usedFake;
                for(let i=1; i<=TOTAL_IMAGES_PER_TYPE; i++) if(!pool.includes(i)) available.push(i);
            }

            photoId = available[Math.floor(Math.random() * available.length)];

            if (currentType === 'real') {
                usedReal.push(photoId);
                localStorage.setItem('ai_game_used_real', JSON.stringify(usedReal));
                document.getElementById('gameImage').src = `real_images/${photoId}.png`;
            } else {
                usedFake.push(photoId);
                localStorage.setItem('ai_game_used_fake', JSON.stringify(usedFake));
                document.getElementById('gameImage').src = `fake_images/${photoId}.png`;
            }

            isGameActive = true;
            startTimer();
            document.getElementById('btnContainer').style.display = 'flex';
        }

        function showEndGameScreen() {
            const overlay = document.getElementById('feedbackOverlay');
            const icon = document.getElementById('feedbackIcon');
            const text = document.getElementById('feedbackText');
            const policeFeedback = document.getElementById('feedbackPoliceImg');
            
            overlay.style.display = 'flex';
            document.getElementById('btnContainer').style.display = 'none';
            document.getElementById('continueHint').style.display = 'none';
            
            // Show Happy Police
            policeFeedback.src = "police_images/Althea_cheer.png";
            
            icon.innerHTML = "";
            text.innerHTML = "üéâ Ë™≤Á®ãÁµêÊùü üéâ<br>ÊâÄÊúâÁÖßÁâáÂ∑≤Êí≠ÊîæÂÆåÁï¢";
            
            // Show Restart Button
            document.getElementById('restartBtn').style.display = 'block';
            
            // Remove click listener on overlay for this state
            overlay.onclick = null; 
        }

        function startTimer() {
            clearInterval(timerInterval);
            clearInterval(heartbeatInterval);
            currentTimer = TIME_LIMIT;
            heartbeatVolume = 0.5;
            const clockEl = document.getElementById('clock');
            clockEl.className = 'clock-container';
            clockEl.innerText = currentTimer;

            timerInterval = setInterval(() => {
                currentTimer--;
                if (currentTimer >= 0) {
                    clockEl.innerText = currentTimer;
                    playTick();
                }
                if (currentTimer <= 0) {
                    clearInterval(timerInterval);
                    enterNervousMode();
                }
            }, 1000);
        }

        function enterNervousMode() {
            const clockEl = document.getElementById('clock');
            clockEl.className = 'clock-container clock-danger';
            clockEl.innerText = "0";
            playHeartbeat();
            heartbeatInterval = setInterval(playHeartbeat, 1000);
        }

        function makeGuess(guess) {
            if (!isGameActive) return;
            isGameActive = false;
            clearInterval(timerInterval);
            clearInterval(heartbeatInterval);

            const isCorrect = (guess === currentType);
            
            if (isCorrect) {
                document.getElementById('policeMain').src = "police_images/Althea_happy.png";
                if(currentScore < MAX_ITEMS) currentScore++;
            } else {
                document.getElementById('policeMain').src = "police_images/Althea_shock.png";
                if(currentScore > 0) currentScore--;
            }

            updateCollectionVisuals();
            showFeedback(isCorrect);
        }

        function updateCollectionVisuals() {
            for(let i=1; i<=MAX_ITEMS; i++) {
                const slot = document.getElementById(`slot-${i}`);
                if (i <= currentScore) {
                    slot.classList.add('unlocked');
                } else {
                    slot.classList.remove('unlocked');
                }
            }
            const percent = (currentScore / MAX_ITEMS) * 100;
            document.getElementById('progressBar').style.width = percent + "%";
        }

        function showFeedback(isCorrect) {
            const overlay = document.getElementById('feedbackOverlay');
            const icon = document.getElementById('feedbackIcon');
            const text = document.getElementById('feedbackText');
            const policeFeedback = document.getElementById('feedbackPoliceImg');
            
            // Ensure default overlay state
            document.getElementById('restartBtn').style.display = 'none';
            document.getElementById('continueHint').style.display = 'block';
            overlay.onclick = nextPhoto;

            document.getElementById('btnContainer').style.display = 'none';
            overlay.style.display = 'flex';

            if (isCorrect) {
                playSuccessSound();
                triggerConfetti();
                
                // Show CHEER Althea
                policeFeedback.src = "police_images/Althea_cheer.png";
                
                // Show CSS Drawn Green Circle
                icon.innerHTML = '<div class="success-mark"></div>';
                text.innerHTML = "Á≠îÂ∞ç‰∫Ü!"; 
            } else {
                playFailSound();
                
                // Show Shock Althea
                policeFeedback.src = "police_images/Althea_shock.png";
                
                // Show Giant Red Cross
                icon.innerHTML = '<div class="cross-mark">‚ùå</div>';
                
                if (currentType === 'fake') {
                    text.innerHTML = "<span style='color:#f44336; font-size:2.5rem; font-weight:bold'>ÈÄôÊòØ AI ÁîüÊàêÁöÑ!</span>";
                } else {
                    text.innerHTML = "<span style='color:#4caf50; font-size:2.5rem; font-weight:bold'>ÈÄôÊòØÁúü‰∫∫ÁÖßÁâá!</span>";
                }
            }
        }

        function nextPhoto() {
            document.getElementById('feedbackOverlay').style.display = 'none';
            loadNextPhoto();
        }

        function triggerConfetti() {
            const colors = ['#00ff41', '#ffff00', '#00e5ff', '#ff00ff', '#ffffff'];
            for (let i = 0; i < 200; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.style.left = Math.random() * 100 + 'vw';
                c.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                c.style.animationDuration = (Math.random() * 2 + 2) + 's';
                c.style.animationDelay = (Math.random() * 1) + 's';
                document.body.appendChild(c);
                setTimeout(() => c.remove(), 5000);
            }
        }

        document.addEventListener('keydown', (e) => {
            if (isGameActive) {
                if (e.key === "ArrowLeft") makeGuess('real');
                if (e.key === "ArrowRight") makeGuess('fake');
            } else {
                if (e.key === " " || e.key === "Enter") nextPhoto();
            }
        });

        function resetMemory() {
            if(confirm("Á¢∫ÂÆöË¶ÅÈáçÁΩÆÊâÄÊúâÁ¥ÄÈåÑÂóé?")) {
                localStorage.removeItem('ai_game_used_real');
                localStorage.removeItem('ai_game_used_fake');
                location.reload();
            }
        }

        // Initially we do NOT start game until button click
        // But we ensure grid is visually ready
        generateGrid();

    </script>
</body>
</html>